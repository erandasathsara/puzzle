<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Indiretto</title>
  <link rel="icon" type="image/png" href="images/logo.png">
  <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css'>
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="./css/leaderboard.css">
</head>

<body>
  <!-- partial:index.partial.html -->
  <div class="wui-side-menu open pinned" data-wui-theme="dark">
    <div class="wui-side-menu-header">
      <a href="#" class="wui-side-menu-trigger"><i class="fa fa-bars"></i></a>
      <a href="#" class="wui-side-menu-pin-trigger">
      </a>
    </div>
    <ul class="wui-side-menu-items">
      <li>
        <img src="./images/logo.png">
      <li>
        <br>
      </li>
      <li>
        <a href="./index.html" class="wui-side-menu-item">
          <i class="box-ico fa fa-home fa-fw"></i>
          <span class="box-title">Home</span>
        </a>
      </li>
      <li>
        <a class="wui-side-menu-item active">
          <i class="box-ico fa fa-list-ol fa-fw"></i>
          <span class="box-title">Leaderboard</span>
        </a>
      </li>
      <li>
        <br><br><br><br><br><br><br><br><br>
      </li>
      <li>
        <a href="#" class="wui-side-menu-item">
          <i class="box-ico fa fa-list-alt fa-fw"></i>
          <span class="box-title">Progress</span>
        </a>
      </li>
      <li>
        <a href="#" class="wui-side-menu-item">
          <i class="fa-solid fa-circle-check"></i>
          <span class="box-title">Level 1</span>
        </a>
      </li>
      <li>
        <a href="#" class="wui-side-menu-item">
          <i class="fa-solid fa-circle-check"></i>
          <span class="box-title">Level 2</span>
        </a>
      </li>
      <li>
        <a href="#" class="wui-side-menu-item">
          <i class="fa-solid fa-circle-check"></i>
          <span class="box-title">Level 3</span>
        </a>
      </li>
      <li>
        <a href="#" class="wui-side-menu-item">
          <i class="fa-solid fa-circle-check"></i>
          <span class="box-title">Level 4</span>
        </a>
      </li>
      <li>
        <a href="#" class="wui-side-menu-item">
          <i class="bfa-solid fa-circle-check"></i>
          <span class="box-title">Level 5</span>
        </a>
      </li>
    </ul>
  </div>
  <div class="wui-content">
    <div class="wui-content-header">
      <a href="#" class="wui-side-menu-trigger"><i class="fa fa-bars"></i></a>
      <span class="wui-title">Leaderboard</span>
    </div>
    <div class="wui-content-main">
      <section>
        <div class="container scorelist">
          <table class="table" style="margin-top: 60px">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Team Name</th>
                <th scope="col">Level</th>
                <th scope="col">Score</th>
              </tr>
            </thead>

            <tbody id="data">
            </tbody>
          </table>
        </div>
      </section>
      <div id="events"></div>
    </div>
  </div>
  <div class="wui-overlay"></div>
  <!-- partial -->
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="./checkAuth.js"></script>
  <script>
    const loadData = async () => {
      const db = firebase.firestore();
      let scores = [];
      try {
        const docs = await db.collection("users").get();

        docs.forEach(doc => {
          scores.push({
            id: doc.id,
            ...doc.data()
          });
        });

        const l4 = [];
        const l5Full = [];
        const l5 = [];
        
        for (let i = 0; i < scores.length; i++) {
        const docQ = await db.collection("crossword_puzzle").where('groupname', '==', scores[i].groupname).get();

        docQ.forEach(doc => {
          l5Full.push(doc.data());
        });
      }

        for (let i = 0; i < scores.length; i++) {
          const doc = await db.collection("crossword_puzzle").doc(scores[i].groupname).get();

          if (doc.exists) {
            const timeSpent = doc.data().endTime - doc.data().startTime;
            l4.push(360000 / (timeSpent / 1000));
          } else {
            l4.push(0);
          }

          const mark = l5Full.find(e => e.TeamName === cores[i].groupname);

          if (mark) {
            l5.push((mark.Mark - 0) * 10);
          } else {
            l5.push(0);
          }
        }

        scores = scores.map((e, idx) => {
          const a = (e.picturePuzzleTime || '0:0:0').split(':').map(e => parseInt(e))
          const totalLevel3 = (a[0] * 60) + a[1] + (a[2] * 0.01);
          return {
            ...e,
            total: ((e.level1Score || 0) + (e.level2Score || 0) + (totalLevel3 || 0) + l4[idx] + l5[idx]) * (e.mul || 1)
          }
        }).sort((a, b) => (a.total > b.total ? -1 : 1));

        console.log(scores);

        document.getElementById('data').innerHTML = scores.filter(e => !isNaN(e.total)).map((e,idx) => {
          return `
          <tr>
                <th scope="row">${idx+1}</th>
                <td>${e.id}</td>
                <td>${e.currentlevel == 99 ? "Finished" : e.currentlevel}</td>
                <td>${e.total.toFixed(2)}</td>
              </tr>
          `
        }).join('');

      } catch (err) {
        console.log(err);
      }

    }
    loadData();
  </script>
  <script src="./script.js"></script>

</body>

</html>